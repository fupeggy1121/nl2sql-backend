# Schema è¯­ä¹‰æ ‡æ³¨ç³»ç»Ÿ - å®ç°å®Œæˆ

## ğŸ“¦ å·²å®ç°çš„ç»„ä»¶

### 1. åç«¯æœåŠ¡å±‚

#### `app/services/schema_annotator.py` âœ…
- **SchemaAnnotator ç±»**: æ ¸å¿ƒæ ‡æ³¨æœåŠ¡
- **ä¸»è¦æ–¹æ³•**:
  - `auto_annotate_table()` - LLM è‡ªåŠ¨æ ‡æ³¨å•ä¸ªè¡¨
  - `save_table_annotation()` - ä¿å­˜è¡¨æ ‡æ³¨
  - `save_column_annotations()` - ä¿å­˜åˆ—æ ‡æ³¨
  - `get_pending_annotations()` - è·å–å¾…å®¡æ ¸æ ‡æ³¨
  - `approve_annotation()` - æ‰¹å‡†æ ‡æ³¨
  - `reject_annotation()` - æ‹’ç»æ ‡æ³¨
  - `update_annotation()` - ç¼–è¾‘æ ‡æ³¨
  - `get_approved_schema_metadata()` - è·å–å·²æ‰¹å‡†çš„å…ƒæ•°æ®

### 2. API è·¯ç”±

#### `app/routes/schema_routes.py` âœ…
æä¾› RESTful API ç«¯ç‚¹:

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/schema/tables/auto-annotate` | POST | è‡ªåŠ¨ç”Ÿæˆè¡¨æ ‡æ³¨ |
| `/api/schema/tables/pending` | GET | è·å–å¾…å®¡æ ¸è¡¨æ ‡æ³¨ |
| `/api/schema/columns/pending` | GET | è·å–å¾…å®¡æ ¸åˆ—æ ‡æ³¨ |
| `/api/schema/tables/<id>/approve` | POST | æ‰¹å‡†è¡¨æ ‡æ³¨ |
| `/api/schema/tables/<id>/reject` | POST | æ‹’ç»è¡¨æ ‡æ³¨ |
| `/api/schema/tables/<id>` | PUT | ç¼–è¾‘è¡¨æ ‡æ³¨ |
| `/api/schema/metadata` | GET | è·å–å·²æ‰¹å‡†çš„å…ƒæ•°æ® |
| `/api/schema/status` | GET | è·å–æ ‡æ³¨è¿›åº¦ |

### 3. æ•°æ®åº“è¿ç§»

#### `supabase/create_annotation_tables.py` âœ…
åŒ…å«å®Œæ•´çš„ SQL è¿ç§»è„šæœ¬ï¼Œåˆ›å»º:

- `schema_table_annotations` - è¡¨çº§æ ‡æ³¨è¡¨
- `schema_column_annotations` - åˆ—çº§æ ‡æ³¨è¡¨
- `schema_relation_annotations` - å…³ç³»æ ‡æ³¨è¡¨
- `annotation_audit_log` - å®¡è®¡æ—¥å¿—è¡¨
- ç›¸å…³ç´¢å¼•å’Œè§¦å‘å™¨
- RLS å®‰å…¨ç­–ç•¥
- `approved_schema_metadata` è§†å›¾

### 4. å·¥å…·è„šæœ¬

#### `app/tools/scan_schema.py` âœ…
æ•°æ®åº“ Schema æ‰«æå™¨
- è¿æ¥ Supabase æ•°æ®åº“
- æ‰«ææ‰€æœ‰è¡¨å’Œåˆ—
- å¯¼å‡º Schema åˆ° JSON

#### `app/tools/auto_annotate_schema.py` âœ…
è‡ªåŠ¨æ ‡æ³¨å·¥å…·
- ä½¿ç”¨ LLM ç”Ÿæˆæ ‡æ³¨
- ä¿å­˜åˆ°æ•°æ®åº“
- æä¾›è¿›åº¦åé¦ˆ

### 5. æ–‡æ¡£

#### `SCHEMA_ANNOTATION_GUIDE.md` âœ…
å®Œæ•´çš„ä½¿ç”¨æŒ‡å—åŒ…å«:
- å¿«é€Ÿå¼€å§‹æ­¥éª¤
- API æ–‡æ¡£
- æ ‡æ³¨ç»“æ„è¯´æ˜
- æœ€ä½³å®è·µ
- æ•…éšœæ’é™¤

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### ç¬¬ä¸€æ­¥: åˆ›å»ºæ•°æ®åº“è¡¨
```bash
python supabase/create_annotation_tables.py
```
ç„¶ååœ¨ Supabase SQL Editor æ‰§è¡Œè¾“å‡ºçš„ SQLã€‚

### ç¬¬äºŒæ­¥: æ‰«ææ•°æ®åº“
```bash
python app/tools/scan_schema.py
```

### ç¬¬ä¸‰æ­¥: è‡ªåŠ¨ç”Ÿæˆæ ‡æ³¨
```bash
python app/tools/auto_annotate_schema.py
```

### ç¬¬å››æ­¥: å®¡æ ¸å’Œæ‰¹å‡†
```bash
# è·å–å¾…å®¡æ ¸çš„æ ‡æ³¨
curl http://localhost:5000/api/schema/tables/pending

# æ‰¹å‡†æ ‡æ³¨
curl -X POST http://localhost:5000/api/schema/tables/<id>/approve \
  -d '{"reviewer": "admin"}'

# ç¼–è¾‘æ ‡æ³¨ï¼ˆå¦‚éœ€è¦ï¼‰
curl -X PUT http://localhost:5000/api/schema/tables/<id> \
  -d '{"description_cn": "æ–°çš„æè¿°"}'
```

### ç¬¬äº”æ­¥: è·å–å·²æ‰¹å‡†çš„å…ƒæ•°æ®ç”¨äº NL2SQL
```bash
curl http://localhost:5000/api/schema/metadata
```

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç”¨æˆ·æ“ä½œå±‚                           â”‚
â”‚  (å®¡æ ¸é¡µé¢ã€API è°ƒç”¨ã€è„šæœ¬æ‰§è¡Œ)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API å±‚                               â”‚
â”‚  /api/schema/tables/pending                          â”‚
â”‚  /api/schema/tables/<id>/approve                     â”‚
â”‚  /api/schema/metadata                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸šåŠ¡é€»è¾‘å±‚                              â”‚
â”‚   SchemaAnnotator (schema_annotator.py)              â”‚
â”‚   - auto_annotate_table()                            â”‚
â”‚   - get_pending_annotations()                        â”‚
â”‚   - approve_annotation()                             â”‚
â”‚   - get_approved_schema_metadata()                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®æŒä¹…åŒ–å±‚                            â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Supabase æ•°æ®åº“     â”‚  â”‚ DeepSeek LLM API   â”‚   â”‚
â”‚  â”‚                     â”‚  â”‚                    â”‚   â”‚
â”‚  â”‚ - Table Annotations â”‚  â”‚ ç”Ÿæˆæ ‡æ³¨           â”‚   â”‚
â”‚  â”‚ - Column Annots     â”‚  â”‚                    â”‚   â”‚
â”‚  â”‚ - Audit Log         â”‚  â”‚                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ é›†æˆåˆ° NL2SQL

### æ–¹å¼ 1: ç›´æ¥é›†æˆåˆ° intent_recognizer

```python
# åœ¨ intent_recognizer.py ä¸­
from app.services.schema_annotator import schema_annotator

def improve_intent_with_metadata():
    metadata = schema_annotator.get_approved_schema_metadata()
    
    # ä½¿ç”¨å…ƒæ•°æ®å¢å¼ºæç¤ºè¯
    prompt = f"""
å·²çŸ¥çš„æ•°æ®åº“è¡¨:
{format_tables(metadata['tables'])}

ç”¨æˆ·æŸ¥è¯¢: {user_query}

æ ¹æ®ä¸Šè¿°è¡¨ç»“æ„ï¼Œè¯†åˆ«ç”¨æˆ·æ„å›¾...
"""
    return llm.generate(prompt)
```

### æ–¹å¼ 2: åœ¨æŸ¥è¯¢æ‰§è¡Œå‰æ£€æŸ¥ç›¸å…³è¡¨

```python
# åœ¨ nl2sql.py ä¸­
def generate_sql(natural_language_query):
    # è·å–æ‰¹å‡†çš„å…ƒæ•°æ®
    metadata = schema_annotator.get_approved_schema_metadata()
    
    # æ‰¾å‡ºæŸ¥è¯¢ç›¸å…³çš„è¡¨
    relevant_tables = find_relevant_tables(
        natural_language_query, 
        metadata
    )
    
    # åªåŒ…å«ç›¸å…³è¡¨çš„ä¿¡æ¯åˆ°æç¤ºè¯
    sql = llm.generate_sql(
        query=natural_language_query,
        relevant_schema=relevant_tables
    )
    
    return sql
```

---

## ğŸ“ˆ è´¨é‡ä¿è¯

### æ ‡æ³¨è´¨é‡æ£€æŸ¥æ¸…å•

- [ ] ä¸­æ–‡åç§°å‡†ç¡®ä¸”ç®€æ´
- [ ] è‹±æ–‡æè¿°è¯­æ³•æ­£ç¡®
- [ ] ä¸šåŠ¡å«ä¹‰æ¸…æ¥šæ˜äº†
- [ ] ç¤ºä¾‹å€¼çœŸå®å¯ä¿¡
- [ ] å–å€¼èŒƒå›´åˆç†
- [ ] è¡¨ä¹‹é—´çš„å…³ç³»æ˜ç¡®

### æµ‹è¯•æ¸…å•

- [ ] API ç«¯ç‚¹æ­£å¸¸å“åº”
- [ ] Supabase è¡¨æ­£ç¡®åˆ›å»º
- [ ] LLM æ ‡æ³¨ç”ŸæˆæˆåŠŸ
- [ ] æ ‡æ³¨ä¿å­˜åˆ°æ•°æ®åº“
- [ ] å®¡æ ¸æµç¨‹æ­£å¸¸è¿ä½œ
- [ ] è·å–å…ƒæ•°æ®ç«¯ç‚¹è¿”å›å®Œæ•´æ•°æ®

---

## ğŸ¯ åç»­ä¼˜åŒ–æ–¹å‘

1. **å‰ç«¯å®¡æ ¸ç•Œé¢**
   - åˆ›å»º React/Vue ç»„ä»¶ç”¨äºå®¡æ ¸æ ‡æ³¨
   - æ”¯æŒæ‰¹é‡å®¡æ ¸
   - æä¾›å¯¹æ¯”æŸ¥çœ‹åŠŸèƒ½

2. **ç‰ˆæœ¬æ§åˆ¶**
   - è®°å½•æ ‡æ³¨çš„ä¿®æ”¹å†å²
   - æ”¯æŒæ ‡æ³¨ç‰ˆæœ¬å›æ»š
   - æ˜¾ç¤ºä¿®æ”¹è€…å’Œæ—¶é—´

3. **è‡ªåŠ¨åŒ–éªŒè¯**
   - éªŒè¯ LLM ç”Ÿæˆçš„ JSON æ ¼å¼
   - æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
   - è‡ªåŠ¨æç¤ºç¼ºå¤±ä¿¡æ¯

4. **å‘é‡åŒ–å­˜å‚¨**
   - ä½¿ç”¨å‘é‡æ•°æ®åº“å­˜å‚¨æ ‡æ³¨
   - æ”¯æŒåŸºäºè¯­ä¹‰çš„æŸ¥è¯¢
   - æ”¹è¿›å…³è”è¡¨çš„è¯†åˆ«

5. **å¤šè¯­è¨€æ”¯æŒ**
   - æ”¯æŒæ›´å¤šè¯­è¨€æ ‡æ³¨
   - è‡ªåŠ¨ç¿»è¯‘åŠŸèƒ½
   - è¯­è¨€ç‰¹å®šçš„ schema ç†è§£

6. **é›†æˆä»ªè¡¨æ¿**
   - æ˜¾ç¤ºæ ‡æ³¨è¿›åº¦
   - ç»Ÿè®¡å·²æ‰¹å‡†çš„æ ‡æ³¨æ•°é‡
   - æ˜¾ç¤ºè¢« NL2SQL ä½¿ç”¨çš„ç»Ÿè®¡

---

## ğŸ“ é…ç½®ä¿¡æ¯

### ç¯å¢ƒå˜é‡éœ€æ±‚

```bash
# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key

# LLM (DeepSeek)
DEEPSEEK_API_KEY=your-deepseek-key

# åº”ç”¨
FLASK_ENV=production
DEBUG=False
```

### ä¾èµ–åŒ…

```
supabase>=1.0.0
Flask>=2.0.0
Flask-CORS>=3.0.0
python-dotenv>=0.19.0
```

---

## ğŸ“ å­¦ä¹ èµ„æº

- [Supabase æ–‡æ¡£](https://supabase.com/docs)
- [PostgreSQL ä¿¡æ¯æ¨¡å¼](https://www.postgresql.org/docs/current/information_schema.html)
- [DeepSeek API æ–‡æ¡£](https://docs.deepseek.com)
- [SQL Server å…ƒæ•°æ®æŸ¥è¯¢](https://docs.microsoft.com/en-us/sql/relational-databases/system-information-schema-views)

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æ”¹è¿›è¿™ä¸ªç³»ç»Ÿï¼å¯ä»¥è´¡çŒ®çš„æ–¹é¢ï¼š

- æ”¹è¿› LLM æç¤ºè¯ç”Ÿæˆæ›´å¥½çš„æ ‡æ³¨
- æ·»åŠ æ›´å¤šçš„éªŒè¯è§„åˆ™
- åˆ›å»ºå‰ç«¯å®¡æ ¸ç•Œé¢
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- æ·»åŠ å¤šè¯­è¨€æ”¯æŒ

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š

1. æ£€æŸ¥æœ¬æŒ‡å—ä¸­çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. æŸ¥çœ‹ Supabase æ—¥å¿—
3. æ£€æŸ¥ DeepSeek API çŠ¶æ€
4. å‚è€ƒç›¸å…³æ–‡æ¡£

---

**å®ç°æ—¥æœŸ**: 2024-02-03  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: ç”Ÿäº§å°±ç»ª âœ…
